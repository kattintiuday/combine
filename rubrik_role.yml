---
- name: Execute PowerShell Script
  hosts: ansible-lab # Change this to your target host
  become: true
  gather_facts: false
  tasks:
    - name: Set Fact the Credentials and Tokens
      set_fact:
        account_name: "{{ lookup('env', 'rb_service_account_name') }}"
        URI: "{{ lookup('env', 'rb_acces_token_uri') }}"
        client_id: "{{ lookup('env', 'rb_client_id') }}"
        rb_client_secret: "{{ lookup('env', 'rb_client_secret') }}"
      no_log: true

    - name: Remove Directory
      file:
        path: /home/admin1/Desktop/GraphQL
        state: absent

    - name: Remove Directory
      file:
        path: /home/admin1/Desktop/GraphQL/queries
        state: absent

    - name: Create directory
      file:
        path: /home/admin1/Desktop/GraphQL
        state: directory

    - name: Create directory
      file:
        path: /home/admin1/Desktop/GraphQL/queries
        state: directory

    - name: Copy PowerShell script from playbook repository
      copy:
        src: 'files/rubrik_sdk_graphql_events_specific_param.ps1'
        dest: /home/admin1/Desktop/GraphQL/

    - name: Copy PowerShell script from playbook repository
      copy:
        src: 'files/Getevents.gql'
        dest: /home/admin1/Desktop/GraphQL/queries/

    - name: Execute PowerShell script with parameters
      shell: |
        pwsh rubrik_sdk_graphql_events_specific_param.ps1 -client_id "{{ client_id }}" -client_secret "{{ rb_client_secret }}" -access_token_uri "{{ URI }}" -lastUpdatedTimeGt "2024-08-01T18:30:00.000Z" -lastUpdatedTimeLt "2024-09-19T18:29:59.999Z"
      args:
        chdir: /home/admin1/Desktop/GraphQL
      no_log: true
